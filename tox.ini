# the tox file specifies a way of running our test suite
# against different combinations of libraries and python
# versions.

[tox]
# Our various test environments. The py*-all tasks will run the core
# library tests and all contrib tests with the latest library versions.
# The others will test specific versions of libraries.
#
# FIXME[gabin]:
# If the env name is longer than 128 characters (linux kernel limit specified
# in "master/include/linux/binfmts.h"), we'll get a "bad interpreter: No such file or directory" error.
#
#See linux kernel limitation:
# - https://github.com/torvalds/linux/blob/master/include/linux/binfmts.h#L12
#
#See related github topic:
# - https://github.com/pypa/virtualenv/issues/596
envlist =
    flake8
    black
    wait
    {py27,py35,py36,py37,py38}-test_utils
# Integrations environments
    aiopg_contrib-{py35,py36}-aiopg{012,015}
    aiopg_contrib-py{37,38}-aiopg015
    algoliasearch_contrib-py{27,35,36,37,38}-algoliasearch{1,2,}
    asyncio_contrib-{py35,py36,py37,py38}
# boto needs moto<1 and moto<1 does not support Python >= 3.7
    boto_contrib-{py27,py35,py36}-boto
    botocore_contrib-{py27,py35,py36,py37,py38}-botocore
    bottle_contrib{,_autopatch}-py{27,35,36,37,38}-bottle{11,12,}-webtest
    cassandra_contrib-{py27,py35,py36,py37,py38}-cassandra{35,36,37,38,315}
    consul_contrib-py{27,35,36,37,38}-consul{07,10,11,}
    dbapi_contrib-py{27,35,36,37,38}
    dogpile_contrib-py{27,35,36,37,38}-dogpilecache{06,07,08,}
    elasticsearch_contrib-{py27,py35,py36}-elasticsearch{16,17,18,23,24,51,52,53,54,63,64}
    elasticsearch_contrib-{py27,py35,py36}-elasticsearch1{100}
    elasticsearch_contrib-{py27,py35,py36}-elasticsearch2{50}
    elasticsearch_contrib-{py27,py35,py36}-elasticsearch5{50}
    elasticsearch_contrib-{py27,py35,py36}-elasticsearch6{40}
    falcon_contrib{,_autopatch}-{py27,py35,py36}-falcon{10,11,12,13,14}
    futures_contrib-py27-futures{30,31,32,}
    futures_contrib-py{35,36,37,38}
    gevent_contrib-{py27,py35,py36}-gevent{11,12,13}
    gevent_contrib-py{37,38}-gevent{13,14}
# gevent 1.0 is not python 3 compatible
    gevent_contrib-{py27}-gevent{10}
# use grpcio versions with bdist_wheel packages for python versions
# py27,py35,py36: grpcio>=1.13.0
# py37: grpcio>=1.13.0
# py38: grpcio>=1.24.3
    grpc_contrib-py{27,35,36}-grpc{112,114,116,118,120,121,122}-googleapis-common-protos
    grpc_contrib-py{37}-grpc{114,116,118,120,121,122,124,126,128,}-googleapis-common-protos
    grpc_contrib-py{38}-grpc{124,126,128,}-googleapis-common-protos
    jinja2_contrib-py{27,35,36,37,38}-jinja{27,28,29,210,211,}
    kombu_contrib-py{27,35,36}-kombu{40,41,42,43,44,45,46,}
# Kombu >= 4.2 only supports Python 3.7+
    kombu_contrib-py{37,38}-kombu{42,43,44,45,46,}
    mako_contrib-py{27,35,36,37,38}-mako{010,100,110,}
    molten_contrib-py{36,37,38}-molten{06,07,10,}
    mongoengine_contrib-py{27,35,36,37,38}-mongoengine{015,016,017,018,}-pymongo
    mysql_contrib-py{27,35,36,37,38}-mysqlconnector{80,}
    mysqldb_contrib-py27-mysqldb{12,}
    mysqldb_contrib-py{27,35,36,37,38}-mysqlclient{13,14,}
    psycopg_contrib-py{27,35,36}-psycopg2{24,25,26,27,28}
    psycopg_contrib-py37-psycopg2{27,28}
# psycopg <2.7 doesn't support Python 3.8: https://github.com/psycopg/psycopg2/issues/854
    psycopg_contrib-py{38}-psycopg2{28}
    pylibmc_contrib-py{27,35,36,37,38}-pylibmc{140,150,}
    pylons_contrib-py27-pylons{096,097,010,10,}
    pymemcache_contrib{,_autopatch}-{py27,py35,py36,py37,py38}-pymemcache{130,140}
    pymongo_contrib-py{27,35,36,37}-pymongo{30,31,32,33,34,35,36,37,38,39,310,}-mongoengine
# pymongo does not yet support Python 3.8: https://github.com/pymssql/pymssql/issues/586
# but these tests still work.
    pymongo_contrib-py38-pymongo{30,31,32,33,35,36,37,38,39,310,}-mongoengine
    pymysql_contrib-py{27,35,36,37,38}-pymysql{07,08,09,}
    pyramid_contrib{,_autopatch}-py{27,35,36,37,38}-pyramid{17,18,19,110,}-webtest
    rediscluster_contrib-py{27,35,36,37,38}-rediscluster{135,136,200,}-redis210
    sqlalchemy_contrib-py{27,35,36,37,38}-sqlalchemy{10,11,12,13,}-psycopg228-mysqlconnector
    benchmarks-{py27,py35,py36,py37,py38}

isolated_build = true

[testenv]
# Always re-run `setup.py develop` to ensure the proper C-extension .so files are created
# DEV: If we don't do this sometimes CircleCI gets messed up and only has the py27 .so
#      meaning running on py3.x will fail
#      https://stackoverflow.com/questions/57459123/why-do-i-need-to-run-tox-twice-to-test-a-python-package-with-c-extension
whitelist_externals=rm
commands_pre={envpython} {toxinidir}/setup.py develop
usedevelop = True

setenv =
    bottle_contrib_autopatch: DATADOG_SERVICE_NAME=bottle-app
    pyramid_contrib_autopatch: DATADOG_SERVICE_NAME=foobar
    pyramid_contrib_autopatch: DATADOG_PYRAMID_DISTRIBUTED_TRACING=True
    falcon_contrib_autopatch: DATADOG_SERVICE_NAME=my-falcon

deps =
    cython
    pdbpp
    pytest>=3
    pytest-benchmark
    pytest-cov
    pytest-mock
    opentracing
# test dependencies installed in all envs
    mock
# backports
    py27: enum34
# integrations
    aiopg012: aiopg>=0.12,<0.13
    aiopg015: aiopg>=0.15,<0.16
    aiopg: sqlalchemy
    algoliasearch: algoliasearch
    algoliasearch1: algoliasearch>=1.2,<2
    algoliasearch2: algoliasearch>=2,<3
    blinker: blinker
    boto: boto
    boto: moto<1.0
    botocore: botocore
    botocore: moto>=1.0,<2
    bottle: bottle
    bottle11: bottle>=0.11,<0.12
    bottle12: bottle>=0.12,<0.13
    cassandra35: cassandra-driver>=3.5,<3.6
    cassandra36: cassandra-driver>=3.6,<3.7
    cassandra37: cassandra-driver>=3.7,<3.8
    cassandra38: cassandra-driver>=3.8,<3.9
    cassandra315: cassandra-driver>=3.15,<3.16
    consul: python-consul
    consul07: python-consul>=0.7,<1.0
    consul10: python-consul>=1.0,<1.1
    consul11: python-consul>=1.1,<1.2
    dogpilecache: dogpile.cache
    dogpilecache06: dogpile.cache==0.6.*
    dogpilecache07: dogpile.cache==0.7.*
    dogpilecache08: dogpile.cache==0.8.*
    elasticsearch16: elasticsearch>=1.6,<1.7
    elasticsearch17: elasticsearch>=1.7,<1.8
    elasticsearch18: elasticsearch>=1.8,<1.9
    elasticsearch23: elasticsearch>=2.3,<2.4
    elasticsearch24: elasticsearch>=2.4,<2.5
    elasticsearch51: elasticsearch>=5.1,<5.2
    elasticsearch52: elasticsearch>=5.2,<5.3
    elasticsearch53: elasticsearch>=5.3,<5.4
    elasticsearch54: elasticsearch>=5.4,<5.5
    elasticsearch63: elasticsearch>=6.3,<6.4
    elasticsearch64: elasticsearch>=6.4,<6.5
    # elasticsearch1 package
    elasticsearch1100: elasticsearch1>=1.10.0,<1.11.0
    # elasticsearch2 package
    elasticsearch250: elasticsearch2>=2.5.0,<2.6.0
    # elasticsearch5 package
    elasticsearch550: elasticsearch5>=5.5.0,<5.6.0
    # elasticsearch6 package
    elasticsearch640: elasticsearch6>=6.4.0,<6.5.0
    falcon10: falcon>=1.0,<1.1
    falcon11: falcon>=1.1,<1.2
    falcon12: falcon>=1.2,<1.3
    falcon13: falcon>=1.3,<1.4
    falcon14: falcon>=1.4,<1.5
    futures: futures
    futures30: futures>=3.0,<3.1
    futures31: futures>=3.1,<3.2
    futures32: futures>=3.2,<3.3
    gevent10: gevent>=1.0,<1.1
    gevent11: gevent>=1.1,<1.2
    gevent12: gevent>=1.2,<1.3
    gevent13: gevent>=1.3,<1.4
    gevent14: gevent>=1.4,<1.5
    grpc: grpcio
    googleapis-common-protos: googleapis-common-protos
    grpc112: grpcio>=1.12,<1.13
    grpc114: grpcio>=1.14,<1.15
    grpc116: grpcio>=1.16,<1.17
    grpc118: grpcio>=1.18,<1.19
    grpc120: grpcio>=1.20,<1.21
    grpc121: grpcio>=1.21,<1.22
    grpc122: grpcio>=1.22,<1.23
    grpc124: grpcio>=1.24,<1.25
    grpc126: grpcio>=1.26,<1.27
    grpc128: grpcio>=1.28,<1.29
    jinja: jinja2
    jinja27: jinja2>=2.7,<2.8
    jinja28: jinja2>=2.8,<2.9
    jinja29: jinja2>=2.9,<2.10
    jinja210: jinja2>=2.10,<2.11
    jinja211: jinja2>=2.11,<2.12
    kombu: kombu
    kombu40: kombu>=4.0,<4.1
    kombu41: kombu>=4.1,<4.2
    kombu42: kombu>=4.2,<4.3
    kombu43: kombu>=4.3,<4.4
    kombu44: kombu>=4.4,<4.5
    kombu45: kombu>=4.5,<4.6
    kombu46: kombu>=4.6,<4.7
    mako: mako
    mako010: mako>=0.1,<1.0
    mako100: mako>=1.0,<1.1
    mako110: mako>=1.1,<1.2
    memcached: python-memcached
    molten: molten
    molten06: molten>=0.6,<0.7
    molten07: molten>=0.7,<0.8
    molten10: molten>=1.0,<1.1
    mongoengine: mongoengine
    mongoengine015: mongoengine>=0.15<0.16
    mongoengine016: mongoengine>=0.16<0.17
    mongoengine017: mongoengine>=0.17<0.18
    mongoengine018: mongoengine>=0.18<0.19
    mongoengine019: mongoengine>=0.19<0.20
    mysqlconnector: mysql-connector-python
    mysqlconnector80: mysql-connector-python>=8.0<8.1
    mysqldb: mysql-python
    mysqldb12: mysql-python>=1.2,<1.3
    mysqlclient: mysqlclient
    mysqlclient13: mysqlclient>=1.3,<1.4
    mysqlclient14: mysqlclient>=1.4,<1.5
    pylibmc: pylibmc
    pylibmc140: pylibmc>=1.4,<1.5
    pylibmc150: pylibmc>=1.5,<1.6
    pylibmc160: pylibmc>=1.6,<1.7
# webob is required for Pylons < 1.0
    pylons: pylons
    pylons096: pylons>=0.9.6,<0.9.7
    pylons096: webob<1.1
    pylons097: pylons>=0.9.7,<0.9.8
    pylons097: webob<1.1
    pylons010: pylons>=0.10,<0.11
    pylons010: webob<1.1
    pylons10: pylons>=1.0,<1.1
    pymemcache130: pymemcache>=1.3.0,<1.4.0
    pymemcache140: pymemcache>=1.4.0,<1.5.0
    pymongo: pymongo
    pymongo30: pymongo>=3.0,<3.1
    pymongo31: pymongo>=3.1,<3.2
    pymongo32: pymongo>=3.2,<3.3
    pymongo33: pymongo>=3.3,<3.4
    pymongo34: pymongo>=3.4,<3.5
    pymongo36: pymongo>=3.6,<3.7
    pymongo37: pymongo>=3.7,<3.8
    pymongo38: pymongo>=3.8,<3.9
    pymongo39: pymongo>=3.9,<3.10
    pymongo310: pymongo>=3.10,<3.11
    pymysql: pymysql
    pymysql07: pymysql>=0.7,<0.8
    pymysql08: pymysql>=0.8,<0.9
    pymysql09: pymysql>=0.9,<0.10
    pyramid: pyramid
    pyramid17: pyramid>=1.7,<1.8
    pyramid18: pyramid>=1.8,<1.9
    pyramid19: pyramid>=1.9,<1.10
    pyramid110: pyramid>=1.10,<1.11
    psycopg224: psycopg2>=2.4,<2.5
    psycopg225: psycopg2>=2.5,<2.6
    psycopg226: psycopg2>=2.6,<2.7
    psycopg227: psycopg2>=2.7,<2.8
    psycopg228: psycopg2>=2.8,<2.9
    rediscluster: redis-py-cluster
    rediscluster135: redis-py-cluster>=1.3.5,<1.3.6
    rediscluster136: redis-py-cluster>=1.3.6,<1.3.7
    rediscluster200: redis-py-cluster>=2.0.0,<2.1.0
    sqlalchemy: sqlalchemy
    sqlalchemy10: sqlalchemy>=1.0,<1.1
    sqlalchemy11: sqlalchemy>=1.1,<1.2
    sqlalchemy12: sqlalchemy>=1.2,<1.3
    sqlalchemy13: sqlalchemy>=1.3,<1.4
    webtest: WebTest

# pass along test env variables
passenv=TEST_*

commands =
# run only essential tests related to the tracing client
# integration tests
    integration: pytest {posargs} tests/test_integration.py
# Contribs
    aiopg_contrib-{py35,py36,py37,py38}: pytest {posargs} tests/contrib/aiopg
    algoliasearch_contrib: pytest {posargs} tests/contrib/algoliasearch
    asyncio_contrib: pytest {posargs} tests/contrib/asyncio
    boto_contrib: pytest {posargs} tests/contrib/boto
    botocore_contrib: pytest {posargs} tests/contrib/botocore
    bottle_contrib: pytest {posargs} --ignore="tests/contrib/bottle/test_autopatch.py" tests/contrib/bottle/
    bottle_contrib_autopatch: python tests/ddtrace_run.py pytest {posargs} tests/contrib/bottle/test_autopatch.py
    cassandra_contrib: pytest {posargs} tests/contrib/cassandra
    consul_contrib: pytest {posargs} tests/contrib/consul
    dbapi_contrib: pytest {posargs} tests/contrib/dbapi
    dogpile_contrib: pytest {posargs} tests/contrib/dogpile_cache
    elasticsearch_contrib: pytest {posargs} tests/contrib/elasticsearch
    falcon_contrib: pytest {posargs} tests/contrib/falcon/test_middleware.py tests/contrib/falcon/test_distributed_tracing.py
    falcon_contrib_autopatch: python tests/ddtrace_run.py pytest {posargs} tests/contrib/falcon/test_autopatch.py
    futures_contrib: pytest {posargs} tests/contrib/futures
    gevent_contrib: pytest {posargs} tests/contrib/gevent
    grpc_contrib: pytest {posargs} tests/contrib/grpc
    jinja2_contrib: pytest {posargs} tests/contrib/jinja2
    mako_contrib: pytest {posargs} tests/contrib/mako
    molten_contrib: pytest {posargs} tests/contrib/molten
    mongoengine_contrib: pytest {posargs} tests/contrib/mongoengine
    mysql_contrib: pytest {posargs} tests/contrib/mysql
    mysqldb_contrib: pytest {posargs} tests/contrib/mysqldb
    psycopg_contrib: pytest {posargs} tests/contrib/psycopg
    pylibmc_contrib: pytest {posargs} tests/contrib/pylibmc
    pylons_contrib: pytest {posargs} tests/contrib/pylons
    pymemcache_contrib: pytest {posargs} --ignore="tests/contrib/pymemcache/autopatch" tests/contrib/pymemcache/
    pymemcache_contrib_autopatch: python tests/ddtrace_run.py pytest {posargs} tests/contrib/pymemcache/autopatch/
    pymongo_contrib: pytest {posargs} tests/contrib/pymongo
    pymysql_contrib: pytest {posargs} tests/contrib/pymysql
    pyramid_contrib: pytest {posargs} tests/contrib/pyramid/test_pyramid.py
    pyramid_contrib_autopatch: python tests/ddtrace_run.py pytest {posargs} tests/contrib/pyramid/test_pyramid_autopatch.py
    rediscluster_contrib: pytest {posargs} tests/contrib/rediscluster
    kombu_contrib: pytest {posargs} tests/contrib/kombu
    sqlalchemy_contrib: pytest {posargs} tests/contrib/sqlalchemy
    tornado_contrib: pytest {posargs} tests/contrib/tornado
# run subsets of the tests for particular library versions
    benchmarks: pytest {posargs} tests/benchmark.py

[testenv:wait]
commands_pre=
skip_install=true
commands=python tests/wait-for-services.py {posargs}
basepython=python
deps=
    cassandra-driver
    psycopg2
    mysql-connector-python!=8.0.18
    redis-py-cluster>=1.3.6,<1.4.0
    vertica-python>=0.6.0,<0.7.0
    kombu>=4.2.0,<4.3.0


# this is somewhat flaky (can fail and still be up) so try the tests anyway
ignore_outcome=true

[testenv:black]
commands_pre=
skip_install=true
deps=black
commands=black --check .

[testenv:flake8]
commands_pre=
skip_install=true
deps=
  flake8>=3.8,<=3.9
  flake8-blind-except
  flake8-builtins
  flake8-docstrings
  flake8-logging-format
  flake8-rst-docstrings
  # needed for some features from flake8-rst-docstrings
  pygments
commands=flake8 .

[testenv:docs]
commands_pre=
extras=
  opentracing
deps=
  sphinx
commands=sphinx-build -W -b html docs docs/_build/html
basepython=python

# DEV: We use `conftest.py` as a local pytest plugin to configure hooks for collection
[pytest]
# Common directories to ignore
addopts = --ignore "tests/utils" --ignore "tests/base" --benchmark-disable --durations=10
# DEV: The default is `test_*\.py` which will miss `test.py` files
python_files = test*\.py

[flake8]
max-line-length=120
exclude=
  .ddtox,.tox,
  .git,__pycache__,
  .eggs,*.egg,
  build,
  # We shouldn't lint our vendored dependencies
  ddtrace/vendor/
  ddtrace/profiling/exporter/pprof_pb2.py
  tests/profiling/_ast_test_file.py
  tests/profiling/simple_program_gevent.py
# Ignore:
# A003: XXX is a python builtin, consider renaming the class attribute
# G201 Logging: .exception(...) should be used instead of .error(..., exc_info=True)
# E231,W503: not respected by black
# We ignore most of the D errors because there are too many; the goal is to fix them eventually
ignore = W503,E231,A003,G201,D100,D101,D102,D103,D104,D105,D106,D107,D200,D202,D204,D205,D208,D210,D300,D400,D401,D403,D413,RST301
enable-extensions=G
rst-roles = class,meth,obj,ref
rst-directives = py:data
