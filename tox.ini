# the tox file specifies a way of running our test suite
# against different combinations of libraries and python
# versions.

[tox]
# Our various test environments. The py*-all tasks will run the core
# library tests and all contrib tests with the latest library versions.
# The others will test specific versions of libraries.
#
# FIXME[gabin]:
# If the env name is longer than 128 characters (linux kernel limit specified
# in "master/include/linux/binfmts.h"), we'll get a "bad interpreter: No such file or directory" error.
#
#See linux kernel limitation:
# - https://github.com/torvalds/linux/blob/master/include/linux/binfmts.h#L12
#
#See related github topic:
# - https://github.com/pypa/virtualenv/issues/596
envlist =
    wait
    # FIXME[riot-3.11]: Riot venvs break with Py 3.11 importlib, specifically with hypothesis (test_http.py).
    # We'll skip the test_http.py tests in riot and run them separately here through tox in CI.
    py{27,35,36,37,38,39,310,311}-tracer_test_http

isolated_build = true

requires = virtualenv<=20.2.1

[testenv]
install_command=python -m pip install {opts} {packages}
usedevelop = true

setenv =
    DD_TESTING_RAISE=1

deps =
    cython<=0.29.32
    cmake
    ninja
    pytest-cov
    pytest-mock
    opentracing
# test dependencies installed in all envs
    mock
    hypothesis

# pass along test env variables
passenv=
    TEST_*
    # https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables
    CI
    CI_*
    CIRCLECI
    CIRCLE_*
    DD_TRACE_AGENT_URL
    DD_API_KEY

commands =
# run only essential tests related to the tracing client
    tracer_test_http: python -m pytest {posargs} tests/tracer/test_http.py
