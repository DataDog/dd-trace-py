#!/usr/bin/env bash
set -e

SCRIPTNAME=$(basename $0)

if [[ $# -lt 3 ]]; then
    cat << EOF
Usage: ${SCRIPTNAME} <scenario> <version> <version> [artifacts]
Examples:
    ${SCRIPTNAME} span ddtrace==0.51.0 ddtrace==0.50.0
    ${SCRIPTNAME} span Datadog/dd-trace-py@v0.51.0 Datadog/dd-trace-py@v0.50.0
    ${SCRIPTNAME} span ddtrace==0.51.0 ddtrace==0.50.0 ./artifacts/

EOF
    exit 1
fi

function expand_git_version {
    gitpattern="dd-trace-py@"
    version=${1}

    if [[ $version =~ $gitpattern ]]; then
        version="git+https://github.com/${version}"
    fi
    echo $version
}

SCENARIO="$1"
shift
DDTRACE_V1="$1"
shift
DDTRACE_V2="$1"
shift

ARTIFACTS=""
if [[ $# -gt 0 ]]; then
    ARTIFACTS="$1"
    shift
fi


# Build scenario image
TAG="dd-trace-py/perf-${SCENARIO}"
scripts/perf-build-scenario "${SCENARIO}" "${TAG}"

# Same run id for all benchmark runs
if [[ -z ${RUN_ID} ]]; then
  RUN_ID=$(uuidgen)
fi

if [[ -n ${ARTIFACTS} ]]; then
   # Resolve artifacts to an absolute path
   ARTIFACTS="$(realpath $ARTIFACTS)"
   mkdir -p ${ARTIFACTS}
   docker run --rm \
          ${DOCKER_RUN_OPTS} \
          -v ${ARTIFACTS}:/artifacts/ \
          -e DDTRACE_INSTALL="$(expand_git_version $DDTRACE_V1)" \
          -e RUN_ID="${RUN_ID}" \
          $TAG
   docker run --rm \
          ${DOCKER_RUN_OPTS} \
          -v ${ARTIFACTS}:/artifacts/ \
          -e DDTRACE_INSTALL="$(expand_git_version $DDTRACE_V2)" \
          -e RUN_ID="${RUN_ID}" \
          $TAG
else
   docker run --rm \
          -e DDTRACE_INSTALL="$(expand_git_version $DDTRACE_V1)" \
          -e RUN_ID="${RUN_ID}" \
          $TAG
   docker run --rm \
          -e DDTRACE_INSTALL="$(expand_git_version $DDTRACE_V2)" \
          -e RUN_ID="${RUN_ID}" \
          $TAG
fi
