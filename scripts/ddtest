#!/usr/bin/env bash

set -e

CMD=$*

if [ -z "$CMD" ]
then
    CMD=bash
fi

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

COMPOSE_FILES=("-f" "$REPO_ROOT/docker-compose.yml")
if command -v nvidia-smi >/dev/null 2>&1; then
    COMPOSE_FILES+=("-f" "$REPO_ROOT/docker-compose.gpu.yml")
fi

docker compose ${COMPOSE_FILES[@]} run \
       -e DD_TRACE_AGENT_URL \
       --rm \
       -i \
       testrunner \
       bash -c "(git config --global --add safe.directory /home/bits/project || true) && $CMD"
