#!/bin/bash
set -e

RIOT_CMD=${1:-riot}

active_hashes=($($RIOT_CMD list --hash-only))

echo "Building requirements lockfiles for riot hashes that don't have them"
for hash in "${active_hashes[@]}"
do
    if [[ ! -f .riot/requirements/"$hash".txt ]]; then
        # Try to compile requirements, but continue on error
        # pip-tools des not currently handle compiling requirements for Python 3.14, so we skip it for now
        if ! $RIOT_CMD -P -v requirements "$hash"; then
            echo "Warning: Failed to compile requirements for hash $hash (likely Python 3.14 compatibility issue), skipping..."
        fi
    fi
done

echo "Removing requirements lockfiles for riot hashes that don't exist"
for file in .riot/requirements/*.txt
do
    file_hash=$(echo "$file" | tr "/" "\n" | grep '.txt' | sed 's/\.txt//')
    if [[ ! " ${active_hashes[*]} " =~ $file_hash ]]
    then
        rm "$file"
    fi
done

echo "All done!"
