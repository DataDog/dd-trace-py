PATTERN=${1}
COVERAGE=${2:-false}
USE_DDTEST=${3:-0}

commit_file="latest-success-commit"

if [[ -f "$commit_file" ]]; then
    echo "Commit file found"
    latest_success_commit=$(cat $commit_file)
    ./scripts/needs_testrun.py $SUITE --sha $latest_success_commit
    [[ $? ]] && exit 0
fi

hashes=$(riot list --hash-only $PATTERN | sort | circleci tests split)

DDTRACE_FLAG=$([ -v _CI_DD_API_KEY ] && echo '--ddtrace')
COVERAGE_FLAG=$([[ "$COVERAGE" == false ]] && echo '--no-cov')
DDTEST_CMD=$([[ $USE_DDTEST ]] && echo "./scripts/ddtest")

all_passed=0
for hash in $hashes; do
    echo "Running tests for $hash"
    $DDTEST_CMD riot -v run --exitfirst --pass-env -s $hash $DDTRACE_FLAG $COVERAGE_FLAG
    [[ $? ]] && break
    all_passed=1
done

[[ $all_passed ]] && echo $CIRCLE_SHA1 > $commit_file

./scripts/check-diff \
    ".riot/requirements/" \
    "Changes detected after running riot. Consider deleting changed files, \
    running scripts/compile-and-prune-test-requirements and committing the result."
