PATTERN=${1}
COVERAGE=${2:-false}
USE_DDTEST=${3}

commit_file="latest-success-commit"

if [[ -f "$commit_file" ]]; then
    latest_success_commit=$(cat $commit_file)
    echo "Latest success commit: " $latest_success_commit
    ./scripts/needs_testrun.py $PATTERN --sha $latest_success_commit
    [[ $? == 1 ]] && exit 0
fi

hashes=$(riot list --hash-only $PATTERN | sort | circleci tests split)

DDTRACE_FLAG=$([ -v _CI_DD_API_KEY ] && echo '--ddtrace')
COVERAGE_FLAG=$([[ "$COVERAGE" == false ]] && echo '--no-cov')
DDTEST_CMD=$([[ $USE_DDTEST == "1" ]] && echo "./scripts/ddtest")

all_passed=false
for hash in $hashes; do
    echo "Running tests for $hash"
    $DDTEST_CMD riot -v run --exitfirst --pass-env -s $hash $DDTRACE_FLAG $COVERAGE_FLAG
    [[ $? > 0 ]] && break
    all_passed=true
done

rm $commit_file
[[ $all_passed == true ]] && echo $CIRCLE_SHA1 > $commit_file && echo "Updated latest success commit"

./scripts/check-diff \
    ".riot/requirements/" \
    "Changes detected after running riot. Consider deleting changed files, \
    running scripts/compile-and-prune-test-requirements and committing the result."
