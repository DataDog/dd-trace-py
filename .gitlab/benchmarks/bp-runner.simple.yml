global_setup:
  - name: Hardware and software info
    run: collect_hardware_software_info

  - name: python-server
    run: service
    cpus: 31-34
    path: .gitlab/benchmarks/steps/start-server.sh
    healthcheck:
      period_secs: 1
      duration_secs: 600
      url: http://localhost:8000/api/articles

experiments:
  - name: warmup
    setup: &services_setup
      - name: datadog-agent
        run: datadog_agent
        cpus: 42-43
        config_sh: .gitlab/benchmarks/steps/update-dd-agent-config.sh

      - name: postgres
        run: service
        cpus: 44-45
        path: .gitlab/benchmarks/steps/start-postgres.sh

      - name: python-server-utilization
        run: monitor_utilization
        cpus: 42-43
        process_name: "gunicorn"
        match_full_process_name: true

    steps: &services_steps
      - name: k6
        cpus: 39-41
        run: shell
        script: .gitlab/benchmarks/steps/start-k6.sh

  - name: normal_operation
    setup: *services_setup
    steps: *services_steps

  - name: high_load
    setup: *services_setup
    steps: *services_steps

global_teardown:
  - name: force kill gunicorn
    run: shell
    script: "pkill -9 gunicorn || :"

  - name: S3 uploading
    run: upload_to_s3

  - name: BP API uploading
    run: upload_to_bp_api
    retries_on_failure: 2
    project: dd-trace-py

docker_config_for_local_runs:
  image_name: bp_python_macrobenchmarks
  volumes:
    - k6/:/app/k6/:ro
    - logs/agent/:/var/log/datadog/:rw
    - src/django-simple:/app/src/django-simple:rw
    - src/flask-simple:/app/src/flask-simple:rw
    - steps/:/app/steps/:ro
    - bp-runner.simple.yml:/app/bp-runner.simple.yml:ro
  env:
    DD_TRACE_DEBUG: "false"
    DD_RUNTIME_METRICS_ENABLED: "true"
  command: bp-runner bp-runner.simple.yml --debug
