build_base_venvs:
  extends: .cached_testrunner
  stage: setup
  needs: []
  parallel:
    matrix:
      - PYTHON_VERSION: ["3.9", "3.10", "3.11", "3.12", "3.13", "3.14"]
  variables:
    CMAKE_BUILD_PARALLEL_LEVEL: '12'
    PIP_VERBOSE: '0'
    DD_PROFILING_NATIVE_TESTS: '1'
    DD_USE_SCCACHE: '1'
    DD_FAST_BUILD: '1'
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'
      variables:
        DD_FAST_BUILD: '0'
    - when: always
  script: |
    set -e -o pipefail
    echo "UNPIN_DEPENDENCIES: ${{UNPIN_DEPENDENCIES}}"
    if [[ ${{UNPIN_DEPENDENCIES:-"false"}} == "true" ]]
    then
      python scripts/allow_prerelease_dependencies.py
      export PIP_PRE=true
    fi
    riot -P -v generate --python=$PYTHON_VERSION
    .riot/venv_py3*/bin/pip freeze
    echo "Running smoke tests"
    riot -v run -s --python=$PYTHON_VERSION smoke_test
  artifacts:
    name: venv_$PYTHON_VERSION
    paths:
      - .riot/venv_*
      - ddtrace/_version.py
      - ddtrace/**/*.so*
      - ddtrace/internal/datadog/profiling/test/test_*
