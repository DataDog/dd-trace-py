variables:
  REPO_LANG: python # "python" is used everywhere rather than "py"
  # CI_DEBUG_SERVICES: "true"

fuzz_infra:
  needs: []
  image:
    name: registry.ddbuild.io/images/mirror/ubuntu:24.04
  tags: ["arch:amd64"]
  stage: fuzz
  timeout: 5m
  allow_failure: true
  rules:
    # runs on gitlab schedule and on merge to main.
    # Also allow manual run in branches for ease of debug / testing
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "schedule"'
    - if: $NIGHTLY_BUILD == "true"
    - when: manual
  before_script:
    # Install build dependencies (same as docker/Dockerfile.fuzz)
    # TODO(taegyunkim): Fuzz with all supported versions of Python (3.9 - 3.14).
    # On ubuntu:24.04 image, python3 version defaults to 3.12.3, meaning that
    # fuzzing will only run for binary that is linked with that version of
    # Python.
    - apt-get update && apt-get install -y --no-install-recommends ca-certificates clang cmake git libclang-rt-dev lld make ninja-build python3 python3-dev python3-pip curl unzip
    - python3 -m pip install requests --break-system-packages
    # Install vault for fuzzing API authentication
    - VAULT_VERSION=1.21.1 && curl -fsSL "https://releases.hashicorp.com/vault/${VAULT_VERSION}/vault_${VAULT_VERSION}_linux_amd64.zip" -o vault.zip && unzip vault.zip && mv vault /usr/local/bin/vault && rm vault.zip && chmod +x /usr/local/bin/vault
    - git config --global --add safe.directory ${CI_PROJECT_DIR}
  script:
    - python3 .gitlab/scripts/fuzz_infra.py
