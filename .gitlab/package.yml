download_ddtrace_artifacts:
  image: registry.ddbuild.io/github-cli:v27480869-eafb11d-2.43.0
  tags: [ "arch:amd64" ]
  stage: package
  id_tokens:
    VAULT_ID_TOKEN:
      aud: "https://vault.us1.ddbuild.io"
  variables:
    VAULT_PATH_PREFIX: "kv/ci/${CI_PROJECT_NAME}/protected"
  before_script:
    - |
      wget -O - https://apt.releases.hashicorp.com/gpg | gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
      echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/hashicorp.list
      apt update && apt install vault
      export VAULT_TOKEN="$(vault write -field=token auth/jwt-gitlab/login role=${CI_PROJECT_NAME}/protected-tag jwt=$VAULT_ID_TOKEN)"
      export VAULT_ADDR=https://vault.us1.ddbuild.io
  script:
    - vault kv get -field=gh_token "${VAULT_PATH_PREFIX}/ci" | gh auth login --with-token
    - .gitlab/download-wheels-from-gh-actions.sh
  artifacts:
    paths:
      - "pywheels/*.whl"
      - "pywheels/*.tar.gz"

download_dependency_wheels:
  image: registry.ddbuild.io/images/mirror/python:$PYTHON_IMAGE_TAG
  tags: [ "arch:amd64" ]
  stage: package
  needs: [ download_ddtrace_artifacts ]
  parallel:
    matrix: # The image tags that are mirrored are in: https://github.com/DataDog/images/blob/master/mirror.yaml
      - PYTHON_IMAGE_TAG: "3.8"
        PYTHON_VERSION: "3.8"
      - PYTHON_IMAGE_TAG: "3.9.13"
        PYTHON_VERSION: "3.9"
      - PYTHON_IMAGE_TAG: "3.10.13"
        PYTHON_VERSION: "3.10"
      - PYTHON_IMAGE_TAG: "3.11.6"
        PYTHON_VERSION: "3.11"
      - PYTHON_IMAGE_TAG: "3.12.0"
        PYTHON_VERSION: "3.12"
      - PYTHON_IMAGE_TAG: "3.13.0"
        PYTHON_VERSION: "3.13"
  script:
    - .gitlab/download-dependency-wheels.sh
  artifacts:
    paths:
      - "pywheels-dep/"
