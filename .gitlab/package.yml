variables:
  PYPA_IMAGE_BASE: registry.ddbuild.io/images/mirror/pypa
  PYPA_IMAGE_TAG: 2025-04-12-5990e2d
  PYPA_DEFAULT_IMAGE: "${PYPA_IMAGE_BASE}/manylinux2014_x86_64:${PYPA_IMAGE_TAG}"

.python_tags: &python_tags
  - "cp38-cp38"
  - "cp39-cp39"
  - "cp310-cp310"
  - "cp311-cp311"
  - "cp312-cp312"
  - "cp313-cp313"

.python_versions: &python_versions
  - "3.8"
  - "3.9"
  - "3.10"
  - "3.11"
  - "3.12"
  - "3.13"

.linux_platforms: &linux_platforms
  - "manylinux2014"
  - "musllinux_1_2"

.setup_rust:
  - |
    # Setup rust
    echo -e "\e[0Ksection_start:`date +%s`:setup_rust[collapsed=true]\r\e[0KSetup rust"
    if [ "$ARCH" == "i686" ] && [ "$PLATFORM" == "musllinux_1_2" ];
    then
      apk add --no-cache gcc libgcc libstdc++ llvm15-libs musl musl-dev rust-stdlib
      apk add --no-cache rust cargo
    else
      curl https://sh.rustup.rs -sSf | sh -s -- --default-toolchain stable -y
    fi
    export PATH=$CARGO_HOME/bin:$PATH
    rustc --version
    echo -e "\e[0Ksection_end:`date +%s`:setup_rust\r\e[0K"

.setup_pip_cache:
  - |
    # Setup pip cache
    echo -e "\e[0Ksection_start:`date +%s`:setup_pip_cache[collapsed=true]\r\e[0KSetup pip cache"
    mkdir -p "${PIP_CACHE_DIR}"
    chown -R "$(id -u):$(id -g)" "${PIP_CACHE_DIR}"
    echo -e "\e[0Ksection_end:`date +%s`:setup_pip_cache\r\e[0K"

.setup_manylinux_python:
    - |
      # Setup python
      echo -e "\e[0Ksection_start:`date +%s`:setup_python[collapsed=true]\r\e[0KSetup python"
      manylinux-interpreters ensure "${PYTHON_TAG}"
      /opt/python/${PYTHON_TAG}/bin/python -m pip install -U -r ".gitlab/package/requirements-${PYTHON_TAG}.txt"
      /opt/python/${PYTHON_TAG}/bin/python --version
      /opt/python/${PYTHON_TAG}/bin/python -m pip --version
      /opt/python/${PYTHON_TAG}/bin/python -m pip cache info
      /opt/python/${PYTHON_TAG}/bin/python -m pip freeze
      echo -e "\e[0Ksection_end:`date +%s`:setup_python\r\e[0K"

.build_ddtrace_base:
  stage: package
  variables:
    CMAKE_BUILD_PARALLEL_LEVEL: 12
    CARGO_BUILD_JOBS: 12
    SYSTEM_VERSION_COMPAT: 0
    PIP_CACHE_DIR: ${CI_PROJECT_DIR}/.cache/pip
    CARGO_HOME: ${CI_PROJECT_DIR}/.cache/cargo
    PIP_LOG: "${CI_PROJECT_DIR}/wheelhouse-debug/${CI_JOB_NAME_SLUG}.pip_debug.log"
    PIP_DISABLE_PIP_VERSION_CHECK: 1
    _DD_DEBUG_EXT: "1"
    _DD_DEBUG_EXT_LOG: "${CI_PROJECT_DIR}/wheelhouse-debug/${CI_JOB_NAME_SLUG}.debug_ext_metadata.log"
  before_script:
    - !reference [ .setup_pip_cache ]
  cache:
    - key: v0-${CI_JOB_NAME_SLUG}-cache
      paths:
        - .cache/

.build_ddtrace_linux_base:
  extends: .build_ddtrace_base
  image: ${PYPA_DEFAULT_IMAGE}
  tags: [ "arch:amd64" ]
  timeout: 10m
  variables:
    KUBERNETES_CPU_REQUEST: 6
    KUBERNETES_MEMORY_REQUEST: 4Gi
    KUBERNETES_MEMORY_LIMIT: 8Gi
  before_script:
    - !reference [ .build_ddtrace_base, before_script ]
    - !reference [ .setup_rust ]
    - !reference [ .setup_manylinux_python ]
  cache:
    - !reference [ .build_ddtrace_base, cache ]
    - key: v0-${CI_JOB_NAME_SLUG}-build
      paths:
        - src/native/target/

"build ddtrace sdist":
  extends: .build_ddtrace_base
  image: ${PYPA_DEFAULT_IMAGE}
  tags: [ "arch:amd64" ]
  variables:
    PYTHON_TAG: cp313-cp313
  script:
    - !reference [ .setup_manylinux_python ]
    - /opt/python/${PYTHON_TAG}/bin/python -m build . --sdist --outdir wheelhouse/
    - /opt/python/${PYTHON_TAG}/bin/python -m twine check --strict wheelhouse/*
  artifacts:
    name: ddtrace-sdist
    paths:
      - wheelhouse/

"build ddtrace linux x86_64":
  extends: .build_ddtrace_linux_base
  image: "${PYPA_IMAGE_BASE}/${PLATFORM}_${ARCH}:${PYPA_IMAGE_TAG}"
  tags: [ "arch:amd64" ]
  parallel:
    matrix:
      - PLATFORM: *linux_platforms
        PYTHON_TAG: *python_tags
  variables:
    ARCH: "x86_64"
  script:
    - |
      # Build the wheel
      echo -e "\e[0Ksection_start:`date +%s`:build_wheel[collapsed=true]\r\e[0KBuild ddtrace wheel"
      echo "pip debug log: ${PIP_LOG}"
      echo "------ DDTRACE STARTING PIP WHEEL BUILD ------" >> "${PIP_LOG}"
      ./.gitlab/package/build_wheel_linux.sh /opt/python/${PYTHON_TAG}/bin/python wheelhouse/
      echo -e "\e[0Ksection_end:`date +%s`:build_wheel\r\e[0K"
    - |
      #Repair the wheel
      echo -e "\e[0Ksection_start:`date +%s`:repair_wheel[collapsed=true]\r\e[0KRepair ddtrace wheel"
      ./.gitlab/package/repair_wheel_linux.sh wheelhouse/
      echo -e "\e[0Ksection_end:`date +%s`:repair_wheel\r\e[0K"
    - |
      # Download wheel dependencies (x86_64 and aarch64)
      echo -e "\e[0Ksection_start:`date +%s`:download_wheel_dependencies[collapsed=true]\r\e[0KDownload wheel dependencies"
      if [ "$ARCH" == "x86_64" ] || [ "$ARCH" == "aarch64" ];
      then
        .gitlab/download-dependency-wheels.sh "/opt/python/${PYTHON_TAG}/bin/python" "${ARCH}" "${PLATFORM}"
      fi

      # Remove ddtrace from the pip cache so it doesn't get uploaded to the gitlab cache
      /opt/python/${PYTHON_TAG}/bin/python -m pip cache remove ddtrace
      echo -e "\e[0Ksection_end:`date +%s`:download_wheel_dependencies\r\e[0K"
  artifacts:
    name: wheelhouse-${PYTHON_TAG}-${PLATFORM}_${ARCH}
    when: always
    paths:
      - wheelhouse/
      - wheelhouse-dep/
      - wheelhouse-debug/

"build ddtrace linux aarch64":
  extends: "build ddtrace linux x86_64"
  image: "${PYPA_IMAGE_BASE}/${PLATFORM}_${ARCH}:${PYPA_IMAGE_TAG}"
  tags: [ "arch:arm64" ]
  parallel:
    matrix:
      - PLATFORM: *linux_platforms
        PYTHON_TAG: *python_tags
  variables:
    ARCH: "aarch64"

"build ddtrace linux i686":
  extends: .build_ddtrace_linux_base
  image: "registry.ddbuild.io/docker:27.3.1"
  tags: [ "runner:docker" ]
  parallel:
    matrix:
      - PLATFORM: *linux_platforms
        PYTHON_TAG: *python_tags
  variables:
    ARCH: "i686"
    IMAGE: "ghcr.io/datadog/dd-trace-py/pypa_${PLATFORM}_${ARCH}:latest"
    DOCKER_DEFAULT_PLATFORM: "linux/386"
  before_script:
    # Do not inherit before_script from .build_ddtrace_linux_base
    - !reference [ .setup_pip_cache ]
    - |
      echo -e "\e[0Ksection_start:`date +%s`:docker_info[collapsed=true]\r\e[0KDocker info"
      docker version
      docker buildx inspect --bootstrap
      docker buildx ls --no-trunc
      echo -e "\e[0Ksection_end:`date +%s`:docker_info\r\e[0K"
  script:
    - |
      # Build the wheel
      echo -e "\e[0Ksection_start:`date +%s`:build_wheel[collapsed=true]\r\e[0KBuild ddtrace wheel"
      docker run --rm -v "$(pwd):/project" -w "/project" -e "PYTHON_TAG=${PYTHON_TAG}" "${IMAGE}" bash -c ".gitlab/package/build_wheel_linux.sh /opt/python/${PYTHON_TAG}/bin/python wheelhouse/"
      echo -e "\e[0Ksection_end:`date +%s`:build_wheel\r\e[0K"
    - |
      #Repair the wheel
      echo -e "\e[0Ksection_start:`date +%s`:repair_wheel[collapsed=true]\r\e[0KRepair ddtrace wheel"
      docker run --rm -v "$(pwd):/project" -w "/project" -e "PYTHON_TAG=${PYTHON_TAG}" ${IMAGE}" bash -c "./.gitlab/package/repair_wheel_linux.sh wheelhouse/"
      echo -e "\e[0Ksection_end:`date +%s`:repair_wheel\r\e[0K"
  artifacts:
    name: wheelhouse-${PYTHON_TAG}-${PLATFORM}_${ARCH}
    paths:
      - wheelhouse/

"build ddtrace macos x86_64":
  extends: .build_ddtrace_base
  tags: [ "macos:sonoma-amd64" ]
  variables:
    UV_CACHE_DIR: "${CI_PROJECT_DIR}/.cache/uv"
    ARCH: "x86_64"
  before_script:
    - !reference [ .setup_pip_cache ]
    - !reference [ .setup_rust ]
    - |
      pip install "uv==0.7.2"
      uv python install "3.8" "3.9" "3.10" "3.11" "3.12" "3.13"
      uv python list
  script:
    - |
      python_tags=( "cp38-cp38" "cp39-cp39" "cp310-cp310" "cp311-cp311" "cp312-cp312" "cp313-cp313" )
      for PYTHON_TAG in "${python_tags[@]}";
      do
        # Convert "cp38-cp38" to "3.8"
        PYTHON_VERSION=$(echo "${PYTHON_TAG:2:2}" | | sed 's/^./&./')
        echo -e "\e[0Ksection_start:`date +%s`:build_wheel_${PYTHON_TAG}[collapsed=true]\r\e[0KBuild ddtrace wheel ${PYTHON_TAG}"
        ./.gitlab/package/build_wheel_linux.sh $(uv python find "${PYTHON_VERSION}") "wheelhouse/"
        echo -e "\e[0Ksection_end:`date +%s`:build_wheel_${PYTHON_TAG}\r\e[0K"
      done
    - |
      #Repair the wheel
      echo -e "\e[0Ksection_start:`date +%s`:repair_wheel[collapsed=true]\r\e[0KRepair ddtrace wheel"
      ./.gitlab/repair_wheel_macos.sh "wheelhouse/" "${ARCH}"
      echo -e "\e[0Ksection_end:`date +%s`:repair_wheel\r\e[0K"
  cache:
    key: v0-${CI_JOB_NAME_SLUG}-cache
    paths:
      - .cache/

"build ddtrace macos arm64":
  extends: "build ddtrace macos x86_64"
  tags: [ "macos:sonoma" ]
  variables:
    ARCH: "arm64"
