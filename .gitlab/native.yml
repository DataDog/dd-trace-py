include:
  - local: ".gitlab/testrunner.yml"

"rust ci":
  stage: tests
  image: !reference [.testrunner, image]
  tags: !reference [.testrunner, tags]
  timeout: 10m
  needs: []
  before_script: cd src/native
  script:
    - |
      echo -e "\e[0Ksection_start:`date +%s`:cargo_fmt[collapsed=true]\r\e[0Kcargo fmt"
      cargo fmt --all -- --check
      echo -e "\e[0Ksection_end:`date +%s`:cargo_fmt\r\e[0K"
    - |
      echo -e "\e[0Ksection_start:`date +%s`:cargo_clippy[collapsed=true]\r\e[0Kcargo clippy"
      cargo clippy -- -D warnings
      echo -e "\e[0Ksection_end:`date +%s`:cargo_clippy\r\e[0K"
    - |
      echo -e "\e[0Ksection_start:`date +%s`:cargo_test[collapsed=true]\r\e[0Kcargo test"
      cargo test --no-fail-fast --locked
      echo -e "\e[0Ksection_end:`date +%s`:cargo_test\r\e[0K"

"clang-tidy profiling":
  stage: tests
  image: registry.ddbuild.io/images/mirror/ubuntu:25.04
  tags: ["arch:amd64"]
  timeout: 20m
  needs: []
  before_script:
    - apt-get update && apt-get install -y clang clang-tidy clang-tools cmake bc python3 python3-pip python3-venv curl jq
    - curl https://sh.rustup.rs -sSf | sh -s -- --default-toolchain stable -y
    - source "$HOME/.cargo/env"
    - python3 -m venv /tmp/venv
    - source /tmp/venv/bin/activate
    - python3 -m pip install setuptools wheel cmake setuptools_rust cython pybind11
  script:
    - |
      echo -e "\e[0Ksection_start:`date +%s`:clang_tidy_build[collapsed=true]\r\e[0Kclang-tidy on profiling C++ code"
      export CMAKE_BUILD_PARALLEL_LEVEL=$(nproc)
      source /tmp/venv/bin/activate
      # Run clang-tidy on profiling C++ code (builds only profiling, skips pip install of full package)
      ddtrace/internal/datadog/profiling/run_clang_tidy.sh
      echo -e "\e[0Ksection_end:`date +%s`:clang_tidy_build\r\e[0K"
