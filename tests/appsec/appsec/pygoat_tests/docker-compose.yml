version: "3"

services:
    testagent:
        image: ghcr.io/datadog/dd-apm-test-agent/ddapm-test-agent:v1.17.0
        ports:
            - "9126:8126"
        expose:
            - "9126"
        volumes:
            - ./tests/snapshots:/snapshots
        environment:
            - LOG_LEVEL=WARNING
            - SNAPSHOT_DIR=/snapshots
            - SNAPSHOT_CI
            - DD_POOL_TRACE_CHECK_FAILURES=true
            - DD_DISABLE_ERROR_RESPONSES=true
            - ENABLED_CHECKS=trace_content_length,trace_stall,meta_tracer_version_header,trace_count_header,trace_peer_service,trace_dd_service
            - SNAPSHOT_IGNORED_ATTRS=span_id,trace_id,parent_id,duration,start,metrics.system.pid,metrics.system.process_id,metrics.process_id,meta.runtime-id,meta._dd.p.tid,meta.pathway.hash,metrics._dd.tracer_kr,meta._dd.parent_id
    pygoat:
        build: .
        expose: 
            - 8000
        environment:
            - DD_APPSEC_ENABLED=1
            - DD_IAST_ENABLED=1
            - DD_TRACE_DEBUG=true
            - DD_IAST_REQUEST_SAMPLING=100
            - DD_AGENT_PORT=8126
            - DD_TRACE_AGENT_URL=http://testagent:8126
            - DD_IAST_VULNERABILITIES_PER_REQUEST=100
            - DD_REMOTE_CONFIGURATION_ENABLED=true
        image: pygoat/pygoat
        command: ddtrace-run python manage.py runserver 0.0.0.0:8000
        ports:
          - "8000:8000"
        depends_on:
          - testagent
        links:
          - testagent
