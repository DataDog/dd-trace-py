name: System Tests Investigation

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch: {}

jobs:
  build-artifact:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/upload-artifact@v4
        with:
          name: dd_trace_py
          path: .

  system-tests:
    needs: build-artifact
    strategy:
      matrix:
        scenario:  # list of scenario knowns to have startup crashes
          - APM_TRACING_E2E_OTEL
          - APPSEC_API_SECURITY
          - APPSEC_API_SECURITY_NO_RESPONSE_BODY
          - APPSEC_API_SECURITY_RC
          - APPSEC_API_SECURITY_WITH_SAMPLING
          - APPSEC_CUSTOM_OBFUSCATION
          - APPSEC_CUSTOM_RULES
          - APPSEC_RATE_LIMITER
          - APPSEC_RASP
          - APPSEC_REQUEST_BLOCKING
          - APPSEC_RUNTIME_ACTIVATION
          - APPSEC_STANDALONE
          - DEBUGGER_EXPRESSION_LANGUAGE
          - TELEMETRY_METRIC_GENERATION_DISABLED
          - TELEMETRY_LOG_GENERATION_DISABLED
        weblog: [flask-poc, uds-flask]
        attempt: [1, 2]  # let's increase the crash probability
      fail-fast: false

    uses: DataDog/system-tests/.github/workflows/system-tests.yml@main
    secrets: inherit
    with:
      library: python
      scenarios: ${{ matrix.scenario }}
      binaries_artifact: dd_trace_py
