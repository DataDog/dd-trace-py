name: django-overhead-profile
on:
  push:
    branches: [master]
  pull_request:
jobs:
  django-overhead-profile-3_1_7:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: django
    steps:
      - uses: actions/checkout@v2
        with:
          path: ddtrace
      - uses: actions/checkout@v2
        with:
          repository: django/django
          ref: 3.1.7
          path: django
      - uses: actions/setup-python@v2
        with:
          python-version: "3.8"
      - name: Install pylibmc's libmemcached package
        # Django-specific: pylibmc in Ubuntu requires libmemcached package
        run: sudo apt install libmemcached-dev zlib1g
      - name: Install dependencies
        # Django-specific: separate dependencies for tests
        run: pip install -r tests/requirements/py3.txt
      - name: Install ddtrace
        run: pip install ../ddtrace
      - name: Install django
        run: pip install .
      - name: Set Pythonpath
        run: echo "PYTHONPATH=." >> $GITHUB_ENV
      - name: Disable unsupported tests
        run: |
          # Note: test_supports_json_field_operational_error will fail with the tracer
          # DEV: Insert @skipUnless before the test definition
          # DEV: We need to escape the space indenting
          sed -i'' '/def test_supports_json_field_operational_error/i \ \ \ \ @skipUnless(False, "test not supported by dd-trace-py")' tests/backends/sqlite/test_features.py

      - name: Checkout Austin development branch
        uses: actions/checkout@v2
        with:
          repository: P403n1x87/austin
          ref: d28108ac30d67c9eb4375e52e93dd0fcf0e75a0d
          path: austin

      - name: Compile Austin on Linux
        run: |
          cd $GITHUB_WORKSPACE/austin
          gcc -Wall -O3 -Os -s -pthread src/*.c -o src/austin
          cd -

      - name: Install diff tool dependencies
        run: |
          pip install rich
          pip install austin-python==0.3.2

      - name: Run tests
        # django.tests.requests module interferes with requests library patching in the tracer -> disable requests patch
        run: |
          mkdir artifacts
          DD_TRACE_REQUESTS_ENABLED=0 ddtrace-run tests/runtests.py -k base &
          sleep 1
          sudo $GITHUB_WORKSPACE/austin/src/austin -o artifacts/django_base.ddtrace.austin -p $!

          tests/runtests.py -k base &
          sleep 1
          sudo $GITHUB_WORKSPACE/austin/src/austin -o artifacts/django_base.austin -p $!

      - name: Compute diff
        run: |
          cd artifacts
          python $GITHUB_WORKSPACE/ddtrace/scripts/diff.py django_base.ddtrace.austin django_base.austin > django_base.diff.austin
          python $GITHUB_WORKSPACE/ddtrace/scripts/diff.py -T django_base.ddtrace.austin django_base.austin > django_base.diff.top
          cat django_base.diff.top
          austin2pprof django_base.diff.austin django_base.diff.pprof
          ls -alh
          cd -

      - uses: actions/upload-artifact@v2
        with:
          name: overhead-profile
          path: ${{ github.workspace }}/django/artifacts

