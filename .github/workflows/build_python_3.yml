name: Build Python 3

on:
  workflow_call:
    inputs:
      cibw_build:
        required: true
        type: string
      cibw_skip:
        required: false
        type: string
      cibw_prerelease_pythons:
        required: false
        type: string

jobs:
  build-wheels-matrix:
    runs-on: ubuntu-latest
    outputs:
      include: ${{steps.set-matrix.outputs.include}}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - uses: ./.github/actions/setup-ci-deps
        with:
          python-version: "3.13"
      - id: set-matrix
        env:
          CIBW_BUILD: ${{ inputs.cibw_build }}
          CIBW_SKIP: ${{ inputs.cibw_skip }}
        run: |
          MATRIX_INCLUDE=$(
            {
              cibuildwheel --print-build-identifiers --platform windows --archs AMD64,x86 | jq -cR '{only: ., os: "windows-latest"}' \
              && cibuildwheel --print-build-identifiers --platform windows --archs ARM64    | jq -cR '{only: ., os: "windows-11-arm"}'
            } | jq -sc
          )
          echo $MATRIX_INCLUDE
          echo "include=${MATRIX_INCLUDE}" >> $GITHUB_OUTPUT

  build:
    needs: ["build-wheels-matrix" ]
    runs-on: ${{ matrix.os }}
    name: Build ${{ matrix.only }}
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.build-wheels-matrix.outputs.include) }}
    env:
      CIBW_SKIP: ${{ inputs.cibw_skip }}
      CIBW_PRERELEASE_PYTHONS: ${{ inputs.cibw_prerelease_pythons }}
      CIBW_BEFORE_ALL_WINDOWS: ${{ matrix.os == 'windows-latest' && 'rustup target add i686-pc-windows-msvc' || (matrix.os == 'windows-11-arm' && 'rustup target add aarch64-pc-windows-msvc') }}
      # cibuildwheel repair will copy anything's under /output directory from the
      # build container to the host machine. This is a bit hacky way, but seems
      # to be the only way getting debug symbols out from the container while
      # we don't mess up with RECORD file.
      CIBW_REPAIR_WHEEL_COMMAND_WINDOWS: python scripts/zip_filter.py "{wheel}" "*.c" "*.cpp" "*.cc" "*.h" "*.hpp" "*.pyx" "*.md" && mv "{wheel}" "{dest_dir}"
      CIBW_TEST_COMMAND: "python {project}/tests/smoke_test.py"

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
          fetch-depth: 0

      - uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        name: Install Python
        with:
          python-version: "3.13"

      - name: Set up QEMU
        if: runner.os == 'Linux' && matrix.os != 'ubuntu-24.04-arm'
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0
        with:
          platforms: all

      - name: Build wheels
        uses: pypa/cibuildwheel@298ed2fb2c105540f5ed055e8a6ad78d82dd3a7e # v3.3.1
        with:
          only: ${{ matrix.only }}

      - name: Validate wheel RECORD files
        shell: bash
        run: |
          for wheel in ./wheelhouse/*.whl; do
            if [ -f "$wheel" ]; then
              echo "Validating $(basename $wheel)..."
              python scripts/validate_wheel.py "$wheel"
            fi
          done

      - if: runner.os != 'Windows'
        run: |
          echo "ARTIFACT_NAME=${{ matrix.only }}" >> $GITHUB_ENV
      - if: runner.os == 'Windows'
        run: |
          chcp 65001 #set code page to utf-8
          echo "ARTIFACT_NAME=${{ matrix.only }}"  >> $env:GITHUB_ENV
      - uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7.0.0
        with:
          name: wheels-${{ env.ARTIFACT_NAME }}
          path: ./wheelhouse/*.whl

      - uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7.0.0
        if: runner.os != 'Windows'
        with:
          name: debug-symbols-${{ env.ARTIFACT_NAME }}
          path: |
            ./debugwheelhouse/*.zip
            ./wheelhouse/debugwheelhouse/*.zip
