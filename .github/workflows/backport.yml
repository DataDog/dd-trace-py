name: Backport
on:
  pull_request:
    types:
      - closed
      - labeled

jobs:
  backport:
    name: Backport
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    # Only react to merged PRs for security reasons.
    # See https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#pull_request_target.
    if: >
      github.event.pull_request.merged
      && (
        (
          github.event.action == 'closed'
          && contains(join(github.event.pull_request.labels.*.name, ','), 'backport ')
        )
        || (
          github.event.action == 'labeled'
          && contains(github.event.label.name, 'backport ')
        )
      )
    steps:
      - uses: DataDog/dd-octo-sts-action@acaa02eee7e3bb0839e4272dacb37b8f3b58ba80 # v1.0.3
        id: octo-sts
        with:
          scope: DataDog/dd-trace-py
          policy: self.backport.create-pr

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Collect Backport Labels (Labeled Event)
        if: github.event.action == 'labeled'
        env:
          BACKPORT_LABEL: ${{ github.event.label.name }}
        run: |
          rm -f /tmp/backport-labels.sorted.txt
          if echo "${BACKPORT_LABEL}" | grep -Eq '^backport [0-9]+\.[0-9]+$'; then
            echo "${BACKPORT_LABEL}" > /tmp/backport-labels.sorted.txt
          else
            echo "Label '${BACKPORT_LABEL}' does not match expected format 'backport x.y'."
            exit 1
          fi

      - name: Collect Backport Labels (Closed Event)
        if: github.event.action == 'closed'
        run: |
          rm -f /tmp/backport-labels.sorted.txt
          jq -r '.pull_request.labels[].name | select(test("^backport [0-9]+\\.[0-9]+$"))' "${GITHUB_EVENT_PATH}" \
            | sort -u \
            > /tmp/backport-labels.sorted.txt
          if [ ! -s /tmp/backport-labels.sorted.txt ]; then
            echo "No backport labels found for this merged PR."
            exit 1
          fi

      - name: Execute Backport
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_BRANCH: ${{ github.head_ref }}
          GH_TOKEN: ${{ steps.octo-sts.outputs.token }}
        run: |
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"

          MERGE_COMMIT=$(git rev-parse HEAD)
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

          while IFS= read -r BACKPORT_LABEL; do
            TARGET_BRANCH=$(echo "${BACKPORT_LABEL}" | awk '{ print $NF }')
            WORKTREE=".worktrees/backport-${TARGET_BRANCH}"
            BACKPORT_BRANCH="backport-${PR_NUMBER}-to-${TARGET_BRANCH}"

            echo "Backporting ${MERGE_COMMIT} to ${TARGET_BRANCH}"
            git worktree add ${WORKTREE} ${TARGET_BRANCH}
            cd ${WORKTREE}
            git branch -D ${BACKPORT_BRANCH} || true
            git switch --create ${BACKPORT_BRANCH}

            set +e
            CHERRYPICK_OUT=$(git cherry-pick -x --mainline 1 ${MERGE_COMMIT} 2>&1)
            CHERRYPICK_STATUS=$?
            set -e
            if [ "${CHERRYPICK_STATUS}" -ne 0 ]; then
              echo "${CHERRYPICK_OUT}"
              git cherry-pick --abort || true
              exit 1
            fi

            git push --force origin ${BACKPORT_BRANCH}
            cd "${GITHUB_WORKSPACE}"
            git worktree remove -f ${WORKTREE}

            EXISTING_PR=$(gh pr list --state open --base ${TARGET_BRANCH} --head ${BACKPORT_BRANCH} --json number --jq '.[0].number')
            if [ -z "${EXISTING_PR}" ]; then
              gh pr create \
                --title "${PR_TITLE} [backport ${TARGET_BRANCH}]" \
                --body "Backport #${PR_NUMBER} to ${TARGET_BRANCH}" \
                --base ${TARGET_BRANCH} \
                --head ${BACKPORT_BRANCH}
            else
              echo "Backport PR already exists for ${TARGET_BRANCH}: #${EXISTING_PR}"
            fi
          done < /tmp/backport-labels.sorted.txt
