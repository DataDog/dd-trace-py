services:
  load-generator:
    build: ./load-generator
    depends_on:
      testagent:
        condition: service_started
      ddagent:
        condition: service_started
      test-service:
        condition: service_started
        #condition: service_healthy
    environment:
      DD_SERVICE: "test-application-generator"
      DD_REMOTE_CONFIGURATION_ENABLED: false
      DD_TRACE_AGENT_URL: "http://testagent:8126"
      DD_TRACE_SAMPLING_RULES: |
          [{"service": "test-application-generator", "sample_rate": 1.0}]
      DD_ENV: "dev"
  test-service:
    extends:
      file: generic-service.yaml
      service: generic-http-framework
  ddagent:
    image: datadog/agent:latest
    pid: host
    environment:
      - DD_API_KEY=${DD_API_KEY}
      - DD_SITE=datadoghq.com
      - DD_APM_ENABLED=true
      #- DD_LOG_LEVEL=TRACE
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /proc/:/host/proc/:ro
      - /sys/fs/cgroup:/host/sys/fs/cgroup:ro
  testagent:
      image: ghcr.io/datadog/dd-apm-test-agent/ddapm-test-agent:v1.17.0
      volumes:
          - ./tests/snapshots:/snapshots
      environment:
          - DD_TRACE_AGENT_URL=http://ddagent:8126
          - LOG_LEVEL=DEBUG
          - SNAPSHOT_DIR=/snapshots
          - SNAPSHOT_CI=0
          - DD_POOL_TRACE_CHECK_FAILURES=true
          - DD_DISABLE_ERROR_RESPONSES=true
          - ENABLED_CHECKS=trace_content_length,trace_stall,meta_tracer_version_header,trace_count_header,trace_peer_service,trace_dd_service
          - SNAPSHOT_IGNORED_ATTRS=span_id,trace_id,parent_id,duration,start,metrics.system.pid,metrics.system.process_id,metrics.process_id,meta.runtime-id,meta._dd.p.tid,meta.pathway.hash,metrics._dd.tracer_kr,meta._dd.parent_id,meta.kafka.cluster_id