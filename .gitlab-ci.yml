stages:
  - discover
  - trigger

variables:
  GIT_STRATEGY: none

# Job 1: Discover branches and output as variables
discover_branches:
  stage: discover
  image: registry.ddbuild.io/images/dd-octo-sts-ci-base:2025.06-1
  tags: ["arch:amd64"]
  id_tokens:
    DDOCTOSTS_ID_TOKEN:
      aud: dd-octo-sts
  script:
    - |
      # Configure gh cli authentication
      if [ -z ${GH_TOKEN} ]; then
        dd-octo-sts token --scope DataDog/dd-trace-py --policy gitlab.github-access.read > token
        gh auth login --with-token < token
        rm token
      fi

      REPO="datadog/dd-trace-py"

      readarray -t VERSIONS < <(
        gh api repos/$REPO/tags --paginate \
        | jq -r '
          [.[].name
           | sub("^v";"")
           | capture("^(?<maj>\\d+)\\.(?<min>\\d+)(?:\\.\\d+)?$")?        # keep only x.y[.z] numeric tags
           | "\(.maj).\(.min)"]                                           # reduce to x.y
          | unique                                                        # dedupe minors
          | sort_by( (split(".")|map(tonumber)) )                         # numeric sort by major, then minor asc
          | . as $minors
          | ($minors | map(split(".")[0]) | unique | map(tonumber)) as $majors
          | ($majors[-1]) as $curMaj
          | ($majors[-2]) as $prevMaj
          | ($minors | map(select((split(".")[0]|tonumber)==$curMaj))) as $curMajMinors
          | [
              $curMajMinors[-1],                                         # current minor (latest 4.x)
              $curMajMinors[-2],                                         # previous minor (previous 4.x)
              ($minors | map(select((split(".")[0]|tonumber)==$prevMaj)))[-1]  # latest from past major (latest 3.x)
            ]
          | .[]'
      )

      # Output discovered branches as dotenv variables
      # Only need: main, current minor (latest 4.x), previous major (latest 3.x)
      echo "BRANCH_MAIN=main" >> branches.env
      echo "BRANCH_CURRENT_MINOR=${VERSIONS[0]}" >> branches.env
      echo "BRANCH_PREV_MAJOR=${VERSIONS[2]}" >> branches.env

      echo "Discovered branches:"
      echo "  main"
      echo "  ${VERSIONS[0]} (latest minor from current major - e.g., 4.0)"
      echo "  ${VERSIONS[2]} (latest minor from previous major - e.g., 3.19)"

      cat branches.env

  artifacts:
    reports:
      dotenv: branches.env
    expire_in: 1 day

# Job 2: Trigger CI for main branch
main:
  stage: trigger
  image: registry.ddbuild.io/images/ddr-ci:3.8.x
  tags: ["arch:amd64"]
  needs:
    - job: discover_branches
      artifacts: true
  script:
    - |
      echo "Triggering CI for branch: ${BRANCH_MAIN}"
      ddr devflow gitlab trigger-ci --repository dd-trace-py --ref "${BRANCH_MAIN}"
      echo "✓ Triggered pipeline for ${BRANCH_MAIN}"

# Job 3: Trigger CI for latest minor from current major (e.g., 4.0)
current minor:
  stage: trigger
  image: registry.ddbuild.io/images/ddr-ci:3.8.x
  tags: ["arch:amd64"]
  needs:
    - job: discover_branches
      artifacts: true
  script:
    - |
      echo "Triggering CI for branch: ${BRANCH_CURRENT_MINOR}"
      ddr devflow gitlab trigger-ci --repository dd-trace-py --ref "${BRANCH_CURRENT_MINOR}"
      echo "✓ Triggered pipeline for ${BRANCH_CURRENT_MINOR}"

# Job 4: Trigger CI for latest minor from previous major (e.g., 3.19)
previous major:
  stage: trigger
  image: registry.ddbuild.io/images/ddr-ci:3.8.x
  tags: ["arch:amd64"]
  needs:
    - job: discover_branches
      artifacts: true
  script:
    - |
      echo "Triggering CI for branch: ${BRANCH_PREV_MAJOR}"
      ddr devflow gitlab trigger-ci --repository dd-trace-py --ref "${BRANCH_PREV_MAJOR}"
      echo "✓ Triggered pipeline for ${BRANCH_PREV_MAJOR}"
