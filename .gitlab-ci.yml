stages:
  - package
  - tests

variables:
  REPO_LANG: python # "python" is used everywhere rather than "py"
  # CI_DEBUG_SERVICES: "true"

default:
  interruptible: true

include:
  - local: ".gitlab/services.yml" # Include early so others can use the definitions
  - local: ".gitlab/testrunner.yml"

tests-gen:
  stage: tests
  extends: .testrunner
  script:
    - pip install riot==0.20.1
    - export DD_NATIVE_SOURCES_HASH=$(scripts/get-native-sources-hash.sh)
    - riot -v run --pass-env -s gitlab-gen-config -v
  needs: []
  artifacts:
    paths:
      - .gitlab/tests-gen.yml

run-tests-trigger:
 stage: tests
 needs: [ tests-gen ]
 trigger:
   include:
     - artifact: .gitlab/tests-gen.yml
       job: tests-gen
   strategy: depend

check_new_flaky_tests:
  stage: tests
  needs: ["run-tests-trigger"]
  extends: .testrunner
  script:
    - export DD_SITE=datadoghq.com
    - export DD_API_KEY=$(aws ssm get-parameter --region us-east-1 --name ci.${CI_PROJECT_NAME}.dd-api-key-qualitygate --with-decryption --query "Parameter.Value" --out text)
    - export DD_APP_KEY=$(aws ssm get-parameter --region us-east-1 --name ci.${CI_PROJECT_NAME}.dd-app-key-qualitygate --with-decryption --query "Parameter.Value" --out text)
    - datadog-ci gate evaluate
  except:
    - main
    - '[0-9].[0-9]*'
    - 'mq-working-branch**'

