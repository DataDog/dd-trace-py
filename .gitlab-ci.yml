stages:
  - discover
  - trigger

discover_branches:
  stage: discover
  image: registry.ddbuild.io/images/dd-octo-sts-ci-base:2025.06-1
  tags: ["arch:amd64"]
  id_tokens:
    DDOCTOSTS_ID_TOKEN:
      aud: dd-octo-sts
  script:
    - |
      # Configure gh cli authentication
      if [ -z ${GH_TOKEN} ]; then
        dd-octo-sts token --scope DataDog/dd-trace-py --policy gitlab.github-access.read > token
        gh auth login --with-token < token
        rm token
      fi

      REPO="datadog/dd-trace-py"

      # Discover branches using existing sophisticated jq logic
      readarray -t VERSIONS < <(
        gh api repos/$REPO/tags --paginate \
        | jq -r '
          [.[].name
           | sub("^v";"")
           | capture("^(?<maj>\\d+)\\.(?<min>\\d+)(?:\\.\\d+)?$")?        # keep only x.y[.z] numeric tags
           | "\(.maj).\(.min)"]                                           # reduce to x.y
          | unique                                                        # dedupe minors
          | sort_by( (split(".")|map(tonumber)) )                         # numeric sort by major, then minor asc
          | . as $minors
          | ($minors | map(split(".")[0]) | unique | map(tonumber)) as $majors
          | ($majors[-1]) as $curMaj
          | ($majors[-2]) as $prevMaj
          | ($minors | map(select((split(".")[0]|tonumber)==$curMaj))) as $curMajMinors
          | [
              $curMajMinors[-1],                                         # current minor (latest 4.x)
              $curMajMinors[-2],                                         # previous minor (previous 4.x)
              ($minors | map(select((split(".")[0]|tonumber)==$prevMaj)))[-1]  # latest from past major (latest 3.x)
            ]
          | .[]'
      )

      # Output discovered branches as dotenv variables
      # Only need: main, current minor (latest 4.x), previous major (latest 3.x)
      echo "BRANCH_MAIN=gnufede/enable-cov-coverage-nightly" >> branches.env
      echo "BRANCH_CURRENT_MINOR=${VERSIONS[0]}" >> branches.env
      echo "BRANCH_PREV_MAJOR=${VERSIONS[2]}" >> branches.env

      echo "Discovered branches:"
      echo "  main"
      echo "  ${VERSIONS[0]} (latest minor from current major - e.g., 4.0)"
      echo "  ${VERSIONS[2]} (latest minor from previous major - e.g., 3.19)"

      cat branches.env

  artifacts:
    reports:
      dotenv: branches.env
    expire_in: 1 day

.trigger_base:
  stage: trigger
  tags: ["arch:amd64"]
  needs:
    - job: discover_branches
      artifacts: true

main:
  extends: .trigger_base
  script: |
    ./trigger-pipeline.sh "${BRANCH_MAIN}"

main (dependencies unpinned):
  extends: .trigger_base
  script: |
    ./trigger-pipeline.sh "${BRANCH_MAIN}"
  variables:
    UNPIN_DEPENDENCIES: true

current minor:
  extends: .trigger_base
  script: |
    ./trigger-pipeline.sh "${BRANCH_CURRENT_MINOR}"

previous major:
  extends: .trigger_base
  script: |
    ./trigger-pipeline.sh "${BRANCH_PREV_MAJOR}"
